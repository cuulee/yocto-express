"use strict";function Express(a){this.DEFAULT_APP_NAME=["app-#",uuid.v4(),"-",df(new Date,"yyyymd")].join(""),this.app=a,this.logger=logger,this.config=config}var df=require("dateformat"),uuid=require("uuid"),_=require("lodash"),logger=require("yocto-logger"),express=require("express"),config=require("yocto-config"),compression=require("compression"),fs=require("fs"),path=require("path"),consolidate=require("consolidate"),favicon=require("serve-favicon");Express.prototype.getSettings=function(){return this.app.settings||{}},Express.prototype.configure=function(){this.logger.banner("[ Express.configure ] - Initializing Express ...");try{if(!this.config.load())throw"Invalid config given. Please check your config files";this.app.set("port",this.config.get("config").port),this.logger.info(["[ Express.configure ] - Setting port to [",this.app.get("port"),"]"].join(" ")),this.app.set("app_name",_.words(this.config.get("config").app.name.toLowerCase()).join("-")),this.logger.info(["[ Express.configure ] - Setting app name to [",this.app.get("app_name"),"]"].join(" ")),this.app.set("env",this.config.get("config").env),this.logger.info(["[ Express.configure ] - Setting env to [",this.app.get("env"),"]"].join(" "));var a=function(a){var b=a.config.get("config").app.stackError||!0;a.app.set("showStackError",b),a.logger.info(["[ Express.configure.enableStackError ] -",b?"Enabling":"Disabling","showStackError"].join(" "))},b=function(a){var b=a.config.get("config").express.prettyHTML||!0;a.app.locals.pretty=b,a.logger.info(["[ Express.configure.enablePrettyHTML] -",b?"Enabling":"Disabling","pretty HTML"].join(" "))},c=function(a){var b=a.config.get("config").express.viewEngine||"jade";a.app.engine(b,consolidate.swig),a.app.set("view engine",b),a.logger.info(["[ Express.configure.processViewEngine ] - Setting view engine to [",a.app.get("view engine"),"]"].join(" "))},d=function(a){var b=a.config.get("config").directory;_.each(b,function(b){a.useDirectory(_.first(Object.keys(b)))},a)},e=function(a){var b=a.config.ICONS_DIRECTORY;"."==b.charAt(0)&&(b=path.normalize([process.cwd(),b].join("/")));var c=[b,"favicon.ico"].join("/");fs.existsSync(c)?(a.logger.info(["[ Express.useFavicon ] - Adding favicon : ",c].join(" ")),a.app.use(favicon(c,{maxAge:2592e6}))):logger.warning(["[ Express.useFavicon ] - Favicon doesn't exist. Checking path [",c,"] failed"].join(" "))},f=function(a){var b=a.config.get("config").express;if(!_.isUndefined(b.filter)){var c=b.filter;_.isUndefined(c.rules)||_.isUndefined(c.by)||_.isUndefined(c.level)||_.isString(c.rules)&&_.isString(c.by)&&_.isNumber(c.level)&&(a.logger.info(["[ Express.enableCompression ] - Setting up compression rules with filter [",c.rules,"] for [",c.by,"] at level [",_.parseInt(c.level),"]"].join(" ")),a.app.use(compression({filter:function(a,b){if(_.has(a,"headers")&&a.headers["x-no-compression"])return!1;var d=new RegExp(c.rules);return d.test(b.getHeader(c.by))},level:_.parseInt(c.level)})))}};a(this),b(this),c(this),d(this),e(this),f(this)}catch(g){return this.logger.error(["[ Express.configure ] - An Error occured during express initialization. error is :",g,"Operation aborted !"].join(" ")),!1}return!0},Express.prototype.useDirectory=function(a,b){if(!_.isUndefined(a)&&!_.isNull(a)&&_.isString(a)&&!_.isEmpty(a)){if(b=_.isUndefined(b)||_.isNull(b)||!_.isString(b)||_.isEmpty(b)?this.config[[a,"DIRECTORY"].join("_").toUpperCase()]||a:b,"."==b.charAt(0)&&(b=path.normalize([process.cwd(),b].join("/"))),fs.existsSync(b))return this.logger.info(["[ Express.useDirectory ] - Adding directory",b,"on express app"].join(" ")),"views"!=a?this.app.use(express["static"](b)):this.app.set(a,b),!0;this.logger.warning(["[ Express.useDirectory ] - Cannot add directory",a,"on express app. Directory [",b,"] does not exist"].join(" "))}return!1},Express.prototype.removeMiddleware=function(a){var b=!1,c=_.findIndex(this.app._router.stack,"name",a);return c>=0&&(this.app._router.stack.splice(c,1),b=!0),this.logger[b?"info":"warning"](["[ Express.removeMiddleware ] - removing middleware",a,b?"success":"failed. Middleware does not exist"].join(" ")),b},Express.prototype.set=function(a,b){return _.isUndefined(a)||!_.isString(a)||_.isEmpty(a)?this.logger.warning("[ Express.set ] - Invalid value given. name must be a string and not empty. Operation aborted !"):this[a]=b,this},module.exports=new Express(express());