<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/index.js - yocto-express</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-express" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 *
 * @see : https://www.npmjs.org/package/uuid 
 * @see : https://www.npmjs.org/package/dateformat
 */
var df            = require(&#x27;dateformat&#x27;);
var uuid          = require(&#x27;uuid&#x27;);
var _             = require(&#x27;lodash&#x27;);
var logger        = require(&#x27;yocto-logger&#x27;);
var express       = require(&#x27;express&#x27;);
var config        = require(&#x27;yocto-config&#x27;);
var compression   = require(&#x27;compression&#x27;);
var fs            = require(&#x27;fs&#x27;);
var path          = require(&#x27;path&#x27;);
var consolidate   = require(&#x27;consolidate&#x27;);
var favicon       = require(&#x27;serve-favicon&#x27;);
var cookieParser  = require(&#x27;cookie-parser&#x27;);
var bodyParser    = require(&#x27;body-parser&#x27;);
var utils         = require(&#x27;yocto-utils&#x27;);
var session       = require(&#x27;express-session&#x27;);
var multipart     = require(&#x27;connect-multiparty&#x27;);
var lusca         = require(&#x27;lusca&#x27;);

// disable config log
//config.logger.enableConsole(false);

function Express(app) {
  /**
   * Default app name const
   * 
   * @property DEFAULT_APP_NAME
   * @type String
   */
  this.DEFAULT_APP_NAME = [ &#x27;app-#&#x27;, uuid.v4(), &#x27;-&#x27;, df(new Date(), &#x27;yyyymd&#x27;) ].join(&#x27;&#x27;);
  
  /**
   * Default app instance
   * 
   * @property app
   * @type Object
   */
  this.app    = app;

  /**
   * Default logger instance
   * 
   * @property logger
   * @type Object
   */
  this.logger = logger;

  /**
   * Default config instance
   * 
   * @property config
   * @type Object
   */
  this.config = config;
}

/**
 * Get settings of express app
 * 
 * @method getSettings
 * @return {Object} settings object or empty object
 */
Express.prototype.getSettings = function() {
  // return object data
  return this.app.settings || {};
};

/**
 * Default configure option
 * 
 * @method configure
 * @return {Boolean} true if all is ok false otherwise
 */
Express.prototype.configure = function() {
  // welcome message ...
  this.logger.banner(&#x27;[ Express.configure ] - Initializing Express ...&#x27;);
  
  // main process
  try {
      if (!this.config.load()) {
        throw &#x27;Invalid config given. Please check your config files&#x27;;
      }
    
      // setting port
      this.app.set(&#x27;port&#x27;, this.config.get(&#x27;config&#x27;).port);
      this.logger.info([ &#x27;[ Express.configure ] - Setting port to [&#x27;, this.app.get(&#x27;port&#x27;), &#x27;]&#x27; ].join(&#x27; &#x27;));
      
      // set defaut name 
      this.app.set(&#x27;app_name&#x27;, _.words(this.config.get(&#x27;config&#x27;).app.name.toLowerCase()).join(&#x27;-&#x27;));
      this.logger.info([ &#x27;[ Express.configure ] - Setting app name to [&#x27;, this.app.get(&#x27;app_name&#x27;), &#x27;]&#x27; ].join(&#x27; &#x27;));
      
      // setting port
      this.app.set(&#x27;env&#x27;, this.config.get(&#x27;config&#x27;).env);
      this.logger.info([ &#x27;[ Express.configure ] - Setting env to [&#x27;, this.app.get(&#x27;env&#x27;), &#x27;]&#x27; ].join(&#x27; &#x27;));
      
      /**
       * Enable stack error
       *
       * @method enableStackError
       * @param {Object} context current context to use
       */
      var processStackError = function(context) {
        //  getting data
        var state = context.config.get(&#x27;config&#x27;).app.stackError || true;
        
        // setting up stack error
        context.app.set(&#x27;showStackError&#x27;, state);
      
        // log state message  
        context.logger.info([ &#x27;[ Express.configure.enableStackError ] -&#x27;, (state ? &#x27;Enabling&#x27; : &#x27;Disabling&#x27;), &#x27;showStackError&#x27; ].join(&#x27; &#x27;));
      };

      /**
       * Enable pretty HTML output
       *
       * @method enablePrettyHTML
       * @param {Object} context current context to use
       */
      var processPrettyHTML = function(context) { 
        // Checking data
        var state = context.config.get(&#x27;config&#x27;).express.prettyHTML || true;
      
        // set value
        context.app.locals.pretty = state;
        // log state message  
        context.logger.info([ &#x27;[ Express.configure.enablePrettyHTML] -&#x27;, (state ? &#x27;Enabling&#x27; : &#x27;Disabling&#x27;), &#x27;pretty HTML&#x27; ].join(&#x27; &#x27;));
      };

      /**
       * Process view engine setting 
       *
       * @method processViewEngine
       * @param {Object} context current context to use
       */
      var processViewEngine = function(context) {
        var name = context.config.get(&#x27;config&#x27;).express.viewEngine || &#x27;jade&#x27;;

        // adding consolidatejs        
        context.app.engine(name, consolidate.swig);

        // change view engine                
        context.app.set(&#x27;view engine&#x27;, name);
        // log message
        context.logger.info([ &#x27;[ Express.configure.processViewEngine ] - Setting view engine to [&#x27;, context.app.get(&#x27;view engine&#x27;), &#x27;]&#x27; ].join(&#x27; &#x27;));        
      };

      /**
       * Process directory path to use on app
       *
       * @method processDirectory
       * @param {Object} context current context to use
       */
      var processDirectory = function(context) {
        // default directory list
        var dir = context.config.get(&#x27;config&#x27;).directory;

        // reading config file
        _.each(dir, function(d) {
          // process
          context.useDirectory(_.first(Object.keys(d)));
        }, context);
      };
      
      /**
       * Setting up favicon
       *
       * @method processFavicon
       * @param {Object} context current context to use
       */
      var processFavicon = function(context) {
        // default path
        var p = context.config.ICONS_DIRECTORY;
      
        // is relative path ?
        if (p.charAt(0) == &#x27;.&#x27;) {
          // normalize path
          p = path.normalize([ process.cwd(), p ].join(&#x27;/&#x27;));  
        }
        
        // build path
        var fav = [ p, &#x27;favicon.ico&#x27; ].join(&#x27;/&#x27;);
      
        // file exists ?
        if (fs.existsSync(fav)) {
          // set and log
          context.logger.info([ &#x27;[ Express.configure.useFavicon ] - Adding favicon : &#x27;, fav ].join(&#x27; &#x27;)); 
          context.app.use(favicon(fav,  { maxAge : 2592000000 } ));
        } else {
          // error
          logger.warning([ &quot;[ Express.configure.useFavicon ] - Favicon doesn&#x27;t exist. Checking path [&quot;, fav, &#x27;] failed&#x27; ].join(&#x27; &#x27;));
        }
      };

      /**
       * process default compression
       *
       * @method processCompression
       * @param {Object} context current context to use
       */
      var processCompression = function(context) {
        // Getting express config
        var eConfig = context.config.get(&#x27;config&#x27;).express;
  
        // Setting up filter for express compression
        if (!(_.isUndefined(eConfig.filter))) {
        
          // getting filter
          var eFilter = eConfig.filter;
        
          // testing rules
          if (!(_.isUndefined(eFilter.rules)) &amp;&amp; !(_.isUndefined(eFilter.by)) &amp;&amp; !(_.isUndefined(eFilter.level))) {
            if ((_.isString(eFilter.rules)) &amp;&amp; (_.isString(eFilter.by)) &amp;&amp; (_.isNumber(eFilter.level))) {
              
              // processsing
              context.logger.info([ &#x27;[ Express.configure.enableCompression ] - Setting up compression rules with filter [&#x27;, eFilter.rules, &#x27;] for [&#x27;, eFilter.by, &#x27;] at level [&#x27;, _.parseInt(eFilter.level), &#x27;]&#x27;].join(&#x27; &#x27;));
              context.app.use(compression({
                filter : function(request, response) {
                  
                  // has header with no compression rules ?
                  if (_.has(request, &#x27;headers&#x27;) &amp;&amp; request.headers[&#x27;x-no-compression&#x27;]) {
                    return false; 
                  }
                  
                  // main compression process
                  var rules = new RegExp(eFilter.rules);
                  return rules.test(response.getHeader(eFilter.by));
                },
                level : _.parseInt(eFilter.level)
              }));
            }
          }
        } 
      };

      /**
       * process jsoncallback state
       *
       * @method processJsonCallack
       * @param {Object} context current context to use
       */
      var processJsonCallack = function(context) {
        
        // get config
        var state = context.config.get(&#x27;config&#x27;).express.jsonp;

        // log specific message
        context.logger[ (state ? &#x27;info&#x27; : &#x27;warning&#x27; )]([ &#x27;[ Express.configure.processJsonCallack ] -&#x27;, (state ? &#x27;Enable&#x27; : &#x27;Disable&#x27;), &#x27;JSONP for express&#x27; ] .join(&#x27; &#x27;));
        
        // process
        context.app.enable(&#x27;jsonp callback&#x27;, state);
      };

      /**
       * process CookieParser state
       *
       * @method processCookieParser
       * @param {Object} context current context to use
       */
      var processCookieParser = function(context) {
        // get config
        var parser = context.config.get(&#x27;config&#x27;).express.cookieParser;

        // log specific message
        context.logger[ (parser.enable ? &#x27;info&#x27; : &#x27;warning&#x27; )]([ &#x27;[ Express.configure.processCookieParser ] -&#x27;, (parser.enable ? &#x27;Enable&#x27; : &#x27;Disable&#x27;), &#x27;cookieParser&#x27; ] .join(&#x27; &#x27;));
        
        // process
        if (parser.enable) {          
          context.app.use(cookieParser(parser.secret, parser.options));
        }
      };

      /**
       * process BodyParser configuration
       *
       * @method processBodyParser
       * @param {Object} context current context to use
       */
      var processBodyParser = function(context, rules) {
        // get current
        var r = context.config.get(&#x27;config&#x27;).express[rules];
        
        // loggin message
        context.logger.info([ &#x27;[ Express.configure.processBodyParser ] - Setting up [&#x27;, rules, &#x27;] parser&#x27; ].join(&#x27; &#x27;));
        context.logger.debug([ &#x27;[ Express.configure.processBodyParser ] - Used params for [&#x27;, rules, &#x27;] config are :&#x27;, utils.strings.inspect(r, false) ].join(&#x27; &#x27;));
        
        // setting up body parser
        context.app.use(bodyParser[rules](r));
      };

      /**
       * process methodOverride configuration
       *
       * @method processMethodOverride
       * @param {Object} context current context to use
       */      
      var processMethodOverride = function(context) {
        // get all methods
        var methods = context.config.get(&#x27;config&#x27;).express.methodOverride;
        // parse available methods
        _.each(methods, function(method) {
          context.logger.info([ &#x27;[ Express.configure.processMethodOverride ] - Setting up methodOverride to use [&#x27;, method, &#x27;] header rules&#x27; ].join(&#x27; &#x27;));
        }, context);
      };

      /**
       * process processSession configuration
       *
       * @method processSession
       * @param {Object} context current context to use
       */   
      var processSession = function(context) {
        // get session data
        var s = context.config.get(&#x27;config&#x27;).express.session;
        
        // session is enable ?
        if (s.enable) {

          // need uuid generator ?
          if (s.options.genuuid) {
            
            // gen function
            var gen = function() {
              return uuid.v4();
            };
            
            // remove state flag non needed on session middleware options
            delete s.options.genuuid;

            // extend options with new genid function
            _.extend(s.options, { genid : gen });
          }
        }
        
        // trust proxy ?
        if (s.options.proxy) {
          context.logger.info(&#x27;[ Express.configure.processSession ] - Enable proxy trust for current express app&#x27;);
          context.app.set(&#x27;trust proxy&#x27;, 1); // trust proxy
        }
        
        // log message
        context.logger.info(&#x27;[ Express.configure.processSession ] - Setting up expression session middleware support for current express app&#x27;);
        context.logger.debug([ &#x27;[ Express.configure.processSession ] - Config data used for session setting are : &#x27;, utils.strings.inspect(s.options, false) ].join(&#x27; &#x27;));

        // is production or staging mode ?
        if (context.app.get(&#x27;env&#x27;) != &#x27;development&#x27;) {
          // force secure cookie
          s.options.cookie.secure = true;
        }
        
        // process assignement
        context.app.use(session(s.options));
      };

      /**
       * process processMultipart configuration
       *
       * @method processMultipart
       * @param {Object} context current context to use
       */
      var processMultipart = function(context) {
        // get multipart state
        var m = context.config.get(&#x27;config&#x27;).express.multipart;

        // enable multiplart ?
        if (m) {
          context.logger.info(&#x27;[ Express.configure.processMultipart ] - Setting up multipart support for current express app&#x27;);
          // setting up multipart
          context.app.use(multipart());                  
        }
      };

      var processSecurity = function(context) {
        // get security data 
        var security = context.config.get(&#x27;config&#x27;).express.security;

        _.each(Object.keys(security), function(rule) {
          // use rules ?        
          if (!_.isEmpty(rule)) {
  
            // log message
            context.logger.info([ &#x27;[ Express.configure.processSecurity ] - Setting up [&#x27;, rule.toUpperCase(), &#x27;] rules for current express app&#x27; ].join(&#x27; &#x27;));
            context.logger.debug([ &#x27;[ Express.configure.processSecurity ] - Config data used for&#x27;, rule.toUpperCase(), &#x27;setting are : &#x27;, utils.strings.inspect(security[rule], false) ].join(&#x27; &#x27;));
  
            // process
            context.app.use(lusca[rule](security[rule]));
          }          
        }, context);
      };

      // process stack error      
      processStackError(this);
      
      // process pretty HTML
      processPrettyHTML(this);
      
      // process view engine
      processViewEngine(this);

      // process directory path
      processDirectory(this);
      
      // process favicon
      processFavicon(this);

      // middleware process
      this.logger.banner(&#x27;[ Express.configure ] - Initializing Express &gt; Processing middleware ...&#x27;);
      
      // process compression
      processCompression(this);
      
      // TODO =&gt; Implement Vhost If needed, we need to check if is required or not (.htaccess process check needed)
      
      // process Jsonp Callback
      processJsonCallack(this);
      
      // process CookieParser
      processCookieParser(this);
      
      // body parser rules
      var brules = [ &#x27;json&#x27;, &#x27;urlencoded&#x27; ];

      // process middleware
      _.each(brules, function(b) {
        // process body parser
        processBodyParser(this, b);        
      }, this);

      // process method override
      processMethodOverride(this);
      
      // process session
      processSession(this);
      
      // process multipart
      processMultipart(this);
      
      // middleware process
      this.logger.banner(&#x27;[ Express.configure ] - Initializing Express &gt; Processing security rules ...&#x27;);      
      
      // enable security
      processSecurity(this);
      
      /**
       * Setting up router
       */
      this.logger.info(&#x27;[ Express.configure ] - Setting up Router for current express app&#x27;);    
      this.app.use(express.Router());

      // TODO =&gt; Implement i18n process with i18next-node for jade or makara for dust 
      // TODO =&gt; Implement https://github.com/auth0/node-jsonwebtoken for secure transaction between apps

      // All is ok !!! run the app      
      this.logger.info(&#x27;[ Express.configure ] - Express is ready to use ....&#x27;);   
      
  } catch (e) {
    this.logger.error([ &#x27;[ Express.configure ] - An Error occured during express initialization. error is :&#x27;, e, &#x27;Operation aborted !&#x27; ] .join(&#x27; &#x27;));
    return false;
  }

  // return true if all is valid 
  return true;
};

/**
 * Set directory to use on express app
 *
 * @method useDirectory
 * @param {String) name nape of path for bind from config file
 * @param {String} p path to use if we need to force the current path manually
 * @return {Boolean} true if success false otherwise
 */
Express.prototype.useDirectory = function(name, p) {
  // checking name
  if (!_.isUndefined(name) &amp;&amp; !_.isNull(name) &amp;&amp; _.isString(name) &amp;&amp; !_.isEmpty(name)) {
    // default path
    p = !_.isUndefined(p) &amp;&amp; !_.isNull(p) &amp;&amp; _.isString(p) &amp;&amp; !_.isEmpty(p) ? p : (this.config[[ name, &#x27;DIRECTORY&#x27; ].join(&#x27;_&#x27;).toUpperCase()] || name);

    // is relative path ?
    if (p.charAt(0) == &#x27;.&#x27;) {
      // normalize path
      p = path.normalize([ process.cwd(), p ].join(&#x27;/&#x27;));  
    }
    
    // directory exist ?
    if (fs.existsSync(p)) {
      
      // adding ? log it
      this.logger.info([ &#x27;[ Express.useDirectory ] - Adding directory&#x27;, p, &#x27;on express app&#x27; ].join(&#x27; &#x27;));
      
      // if views ?? process are different !!!
      if (name != &#x27;views&#x27;) {
        // set static directory
        this.app.use(express.static(p));
      } else {
        // set views
        this.app.set(name, p);
      }
      
      // return success statement
      return true;
    }
    
    // log message
    this.logger.warning([ &#x27;[ Express.useDirectory ] - Cannot add directory&#x27;, name, &#x27;on express app. Directory [&#x27;, p, &#x27;] does not exist&#x27; ].join(&#x27; &#x27;));
  }
  
  // return failed statement
  return false;
};

/**
 * Removing middleware form key name
 *
 * @method removeMiddleware
 * @param {String} name name of middleware to remove
 * @return {Array} list of middleware
 */
Express.prototype.removeMiddleware = function(name) {
  // default state
  var state = false;
  
  // parse router stack
  var middlewareIndex = _.findIndex(this.app._router.stack, &#x27;name&#x27;, name);
  
  // if correct index ?
  if (middlewareIndex &gt;= 0) {
    // remove item on stack
    this.app._router.stack.splice(middlewareIndex, 1);

    // change state
    state = true;
  }
  
  // log
  this.logger[ (state ? &#x27;info&#x27; : &#x27;warning&#x27;) ]([ &#x27;[ Express.removeMiddleware ] - removing middleware&#x27;, name, (state ? &#x27;success&#x27; : &#x27;failed. Middleware does not exist&#x27;) ].join(&#x27; &#x27;));    
  
  // return state
  return state;
};

/**
 * get set function, assign given data to a property
 *
 * @method set
 * @param {String} name name of property
 * @param {Mixed} value value of property
 * @return {Object} current instance 
 */
Express.prototype.set = function(name, value) {
  // check requirements
  if (!_.isUndefined(name) &amp;&amp; _.isString(name) &amp;&amp; !_.isEmpty(name)) {    
    // assign value
    this[name] = value;  
  } else {
    // log a warning messsage.
    this.logger.warning(&#x27;[ Express.set ] - Invalid value given. name must be a string and not empty. Operation aborted !&#x27;);
  }
  
  // returning current instance
  return this;
};

// Instanciate express with default express engine.
// Set method is available for module usage or override
module.exports = new (Express)(express());
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
